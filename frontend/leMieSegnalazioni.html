<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Mie Segnalazioni</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/pages/leMieSegnalazioni.css"> <!-- Potresti voler creare un CSS specifico o adattare quello esistente -->
</head>

<body>
    <header class="py-3 mb-4 border-bottom d-none d-lg-block custom-header">
        <div class="container d-flex flex-wrap justify-content-between align-items-center">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <ul class="nav nav-pills align-items-center">
                <li class="nav-item dropdown invisible">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardUtente.html"><i class="bi bi-person-fill me-2"></i>IL MIO PROFILO</a></li>
                        <li><a class="dropdown-item" href="dashboardStoricoOrdini.html"><i class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI</a></li>
                        <li><a class="dropdown-item active" href="leMieSegnalazioni.html"><i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="logout.html"><i class="bi bi-box-arrow-right me-2"></i>LOGOUT</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown invisible-admin">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <!-- ADMIN -->
                    <ul class="invisible-admin dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="accettazioniAdmin.html"><i class="bi bi-person-fill me-2"></i>ACCETTAZIONE</a></li>
                        <li><a class="dropdown-item" href="gestione.html"><i class="bi bi-box-seam-fill me-2"></i>GESTIONE SEGNALAZIONE</a></li>
                        <li><a class="dropdown-item" href="segnalazioniAdmin.html"><i class="bi bi-flag-fill me-2"></i>LOGOUT</a></li>
                    </ul>
                    <!-- FINE -->
                </li>
                <!-- UNLOGGED -->
                <li class="nav-item unlogged"><a href="login.html" class="nav-link" style="color: var(--secondary-color);">ACCEDI</a></li>
                <li class="nav-item unlogged" style="color: var(--secondary-color)">|</li>
                <li class="nav-item unlogged"><a href="registrati.html" class="nav-link" style="color: var(--secondary-color);">REGISTRATI</a></li>
                <!--FINE-->
                <li class="nav-item">
                    <!-- UNLOGGED -->
                    <a href="login.html" class="nav-link unlogged" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-4"></i>
                    </a>
                    <!--FINE-->
                    <a href="carrelloUtente.html" class="nav-link invisible" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </header>

<!-- Navbar per schermi < lg -->
    <nav class="py-3 navbar bg-body-tertiary fixed-top d-lg-none"> <!-- Mantenuto fixed-top come richiesto in precedenza -->
         <div class="container-fluid d-flex justify-content-between align-items-center">
            <button class="navbar-toggler me-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <div class="ms-auto"></div> <!-- Spacer to push toggler and logo to the left -->

            <!-- Offcanvas UNLOGGED -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header unlogged">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Men√π</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body unlogged">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="login.html">
                                <i class="bi bi-person-fill me-2"></i>ACCEDI
                            </a>
                        </li>
                        <li class="nav-item">
                             <a class="nav-link active" aria-current="page" href="registrati.html"> <i class="bi bi-pencil-square me-2"></i>REGISTRATI
                             </a>
                        </li>
                        </ul>
                    </div>
                </div>

                <!-- Offcanvas menu LOGGED-->
                <div class="offcanvas-header invisible">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Il Mio Account</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body invisible">
                     <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardUtente.html">
                                <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                            </a>
                        </li>
                        <li class="nav-item">
                             <a class="nav-link" aria-current="page" href="dashboardStoricoOrdini.html"> <i class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                             </a>
                        </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="/leMieSegnalazioni.html"> <i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                                </a>
                            </li>
                            </ul>
                        <hr class="sidebar-divider">
                        <a href="logout.html">
                            <button class="btn logout-btn w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                            </button>
                        </a>
                    </div>
                </div>
            </div>
           <ul class="nav nav-pills align-items-center"> <!-- Rimosso ms-auto qui, lo gestisce justify-content-between -->
                <li class="nav-item"> <!-- Aggiunto ms-auto all'ul per spingerlo a destra -->
                    <a href="carrelloUtente.html" class="nav-link nav-link-cart invisible">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                    <a href="login.html" class="nav-link nav-link-cart unlogged">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container my-4 pt-5 pt-lg-0">
        <h2 class="page-main-title mb-4">Le Mie Segnalazioni</h2>
        <div class="row">
            <!-- LOGGED -->
            <div id="menuLogged" class="col-md-3">
                <div class="dashboard-sidebar d-flex flex-column">
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardUtente.html">
                                <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardStoricoOrdini.html"> <i class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/leMieSegnalazioni.html"> <i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                            </a>
                        </li>
                    </ul>
                    <hr class="sidebar-divider">
                    <button onclick="() => {window.location.replace('/logout.html')}" class="btn logout-btn w-100">
                        <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                    </button>
                </div>
            </div>

            <!-- ARTIGIANO -->
            <div id="menuArtigiano" class="col-md-3">
                <div class="dashboard-sidebar d-flex flex-column">
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardArtigiano.html">
                                <i class="bi bi-person-workspace me-2"></i>IL MIO PROFILO
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="prodottiArtigiano.html"> <i class="bi bi-box2-heart-fill me-2"></i>I MIEI PRODOTTI
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" aria-current="page" href="ordiniRicevuti.html"> <i class="bi bi-receipt-cutoff me-2"></i>ORDINI RICEVUTI
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="leMieSegnalazioni.html"> <i class="bi bi-flag-fill me-2"></i>SEGNALAZIONI
                            </a>
                        </li>
                    </ul>
                    <hr class="sidebar-divider">
                    <button class="btn logout-btn w-100">
                        <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                    </button>
                </div>
            </div>

            <div class="col-md-9">
                <div class="dashboard-content p-4">
                    <h3 class="content-title mb-4">Riepilogo Segnalazioni</h3>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th scope="col">ID Segn.</th>
                                    <th scope="col">Data</th>
                                    <th scope="col">ID Ordine</th>
                                    <th scope="col">Descrizione</th>
                                    <th scope="col" style="width: 100px;">Immagine</th>
                                    <th scope="col" style="min-width: 160px;">Stato</th>
                                    <th scope="col">Risolutore Admin (Opz.)</th>
                                </tr>
                            </thead>
                            <tbody id="problems">
                                <!-- Esempio Segnalazione 1 -->
                                <tr>
                                    <th scope="row">SGN001</th>
                                    <td>2024-05-20</td>
                                    <td>ORD123</td>
                                    <td style="white-space: normal; word-break: break-word; min-width: 200px;">Lorem
                                        ipsum dolor sit amet, consectetuer adipiscing elit. Aenean commodo ligula eget
                                        dolor. Aenean massa. Cum sociis natoque penatibus et magnis dis parturient
                                        montes, nascetur ridiculus mus. Donec quam felis, ultricies nec, pellentesque
                                        eu, pretium quis,</td>
                                    <td><a href="#" data-bs-toggle="modal" data-bs-target="#imageModal1">Visualizza</a>
                                    </td>
                                    <td>In Lavorazione</td>
                                    <td>N/A</td> <!-- Esempio per Risolutore Admin -->
                                </tr>
                                <!-- Esempio Segnalazione 2 -->
                                <tr>
                                    <th scope="row">SGN002</th>
                                    <td>2024-05-21</td>
                                    <td>N/A</td>
                                    <td style="white-space: normal; word-break: break-word; min-width: 200px;">Problema
                                        con la visualizzazione delle mie inserzioni.</td>
                                    <td>N/A</td>
                                    <td>Aperto</td>
                                    <td>N/A</td> <!-- Esempio per Risolutore Admin -->
                                </tr>
                                <!-- Aggiungi altre righe per altre segnalazioni qui -->
                            </tbody>
                        </table>
                        <!--bottone aggiunta segnalazione SOLO ARTIGIANO-->
                        <button type="button" onclick="() => {window.location.href='/nuovaSegnalazione.html'}" id="aggiungiSegnalazioneBtn" class="btn btn-primary shadow-lg">
                            <i class="bi bi-plus-lg me-1"></i> Nuova Segnalazione
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Esempio di Modal per Visualizzare Immagine (da replicare e personalizzare per ogni immagine) -->
    <div class="modal fade" id="imageModal1" tabindex="-1" aria-labelledby="imageModal1Label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="imageModal1Label">Immagine Segnalazione SGN001</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img src="https://fastly.picsum.photos/id/237/200/300.jpg?hmac=TmmQSbShHz9CdQm0NkEjx1Dyh_Y984R9LpNrpvH2D_U"
                        class="img-fluid" alt="Immagine segnalazione">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/fetcher.js"></script>
    <script src="js/headerShower.js"></script>
    <script src="js/dateExport.js"></script>
    <script>
        function showProblems(result){
            let problemsRes = ``;
                const products = result.data.map((problem) => {
                    problem.immagine_url != null ?
                    problemsRes += (
                        `<tr>
                            <th scope="row">${problem.idproblema}</th>
                            <td>${combineDateTime(problem.data, problem.ora)}</td>
                            <td>${problem.idordine}</td>
                            <td style="white-space: normal; word-break: break-word; min-width: 200px;">${problem.descrizione}</td>
                            <td><a href="${problem.immagine_url}" data-bs-toggle="modal" data-bs-target="#imageModal1">Visualizza</a>
                            </td>
                            <td>${problem.status}</td>
                            <td>${problem.username_admin}</td> <!-- Esempio per Risolutore Admin -->
                        </tr>`
                    ) : 
                    (
                        `<tr>
                            <th scope="row">${problem.idproblema}</th>
                            <td>${combineDateTime(problem.data, problem.ora)}</td>
                            <td>${problem.idordine}</td>
                            <td style="white-space: normal; word-break: break-word; min-width: 200px;">${problem.descrizione}</td>
                            <td>N/A</td>
                            <td>${problem.status}</td>
                            <td>${problem.username_admin}</td>
                        </tr>`
                    )
                });


                document.getElementById("problems").innerHTML = problemsRes;
        }

        document.addEventListener("DOMContentLoaded", async function(){

            let ruolo = (await fetchData("/api/auth/session-info", "GET")).data.tipologia;
            const buttonAddProblem = document.getElementById("aggiungiSegnalazioneBtn");
            const menuArtigiano = document.getElementById("menuArtigiano");
            const menuLogged = document.getElementById("menuLogged");
            if(ruolo != "Artigiano"){
                buttonAddProblem.style.display = "none";
                menuArtigiano.style.display = "none";
            }else{
                menuLogged.style.display = "none";
            }

            let result = await fetchData(`/api/problems/me`, "GET");
            console.log(result);
            if(result.status == 200){
                showProblems(result);
            }else{
                console.log("Errore caricamento dati!")
            }
        });
    </script>
</body>

</html>