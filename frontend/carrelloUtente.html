<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrello</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/pages/carrelloUtente.css">
</head>
<body>
    <header class="py-3 mb-4 border-bottom d-none d-lg-block custom-header">
        <div class="container d-flex flex-wrap justify-content-between align-items-center">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <ul class="nav nav-pills align-items-center">
                <li class="nav-item dropdown invisible">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardUtente.html"><i class="bi bi-person-fill me-2"></i>IL MIO PROFILO</a></li>
                        <li><a class="dropdown-item" href="dashboardStoricoOrdini.html"><i class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI</a></li>
                        <li><a class="dropdown-item" href="leMieSegnalazioni.html"><i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="logout.html"><i class="bi bi-box-arrow-right me-2"></i>LOGOUT</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown invisible-admin">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <!-- ADMIN -->
                    <ul class="invisible-admin dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardAdmin.html"><i class="bi bi-person-fill me-2"></i>ACCETTAZIONE</a></li>
                        <li><a class="dropdown-item" href="gestione.html"><i class="bi bi-box-seam-fill me-2"></i>GESTIONE SEGNALAZIONE</a></li>
                        <li><a class="dropdown-item" href="logout.html"><i class="bi bi-flag-fill me-2"></i>LOGOUT</a></li>
                    </ul>
                    <!-- FINE -->
                </li>
                <!-- UNLOGGED -->
                <li class="nav-item unlogged"><a href="login.html" class="nav-link" style="color: var(--secondary-color);">ACCEDI</a></li>
                <li class="nav-item unlogged" style="color: var(--secondary-color)">|</li>
                <li class="nav-item unlogged"><a href="registrati.html" class="nav-link" style="color: var(--secondary-color);">REGISTRATI</a></li>
                <!--FINE-->
                <li class="nav-item">
                    <!-- UNLOGGED -->
                    <a href="login.html" class="nav-link unlogged" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-4"></i>
                    </a>
                    <!--FINE-->
                    <a href="carrelloUtente.html" class="nav-link invisible" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </header>

<!-- Navbar per schermi < lg -->
    <nav class="py-3 navbar bg-body-tertiary fixed-top d-lg-none"> <!-- Mantenuto fixed-top come richiesto in precedenza -->
         <div class="container-fluid d-flex justify-content-between align-items-center">
            <button class="navbar-toggler me-auto" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>
            <div class="ms-auto"></div> <!-- Spacer to push toggler and logo to the left -->

            <!-- Offcanvas UNLOGGED -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header unlogged">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menù</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body unlogged">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="login.html">
                                <i class="bi bi-person-fill me-2"></i>ACCEDI
                            </a>
                        </li>
                        <li class="nav-item">
                             <a class="nav-link active" aria-current="page" href="registrati.html"> <i class="bi bi-pencil-square me-2"></i>REGISTRATI
                             </a>
                        </li>
                        </ul>
                    </div>
                </div>

                <!-- Offcanvas menu LOGGED-->
                <div class="offcanvas-header invisible">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Il Mio Account</h5>
                     <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body invisible">
                     <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardUtente.html">
                                <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                            </a>
                        </li>
                        <li class="nav-item">
                             <a class="nav-link" aria-current="page" href="dashboardStoricoOrdini.html"> <i class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                             </a>
                        </li>
                            <li class="nav-item">
                                <a class="nav-link" href="leMieSegnalazioni.html"> <i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                                </a>
                            </li>
                            </ul>
                        <hr class="sidebar-divider">
                        <a href="logout.html">
                            <button class="btn logout-btn w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                            </button>
                        </a>
                    </div>
                </div>
            </div>
           <ul class="nav nav-pills align-items-center"> <!-- Rimosso ms-auto qui, lo gestisce justify-content-between -->
                <li class="nav-item"> <!-- Aggiunto ms-auto all'ul per spingerlo a destra -->
                    <a href="carrelloUtente.html" class="nav-link nav-link-cart invisible">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                    <a href="login.html" class="nav-link nav-link-cart unlogged">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container my-4 pt-2 pt-lg-0">
        <div class="row mb-3 align-items-baseline">
            <div class="col-8 col-md-9">
                <h2 class="cart-page-title">Carrello</h2>
            </div>
        </div>

        <div class="row">
            <div id="cart-content-column" class="col-lg-8">
                <div id="cart-products" class="cart-items-list">
                    <p class="text-center p-4" style="color: var(--primary-color);">PRODOTTI IN CARICAMENTO...</p>
                </div>
                <div id="empty-cart-message" class="text-center p-4 my-3" style="display: none; border: 1px dashed var(--secondary-color); border-radius: .375rem; background-color: #f8f9fa;">
                    <i class="bi bi-cart-x" style="font-size: 3rem; color: var(--primary-color);"></i>
                    <h4 class="mt-3 mb-2">Il tuo carrello è un po' timido... è vuoto!</h4>
                    <p class="text-muted">Non hai ancora aggiunto nessun prodotto. <br> Esplora il nostro catalogo per trovare qualcosa di speciale!</p>
                    <a href="index.html" class="btn btn-primary mt-2" style="background-color: var(--primary-color); border-color: var(--primary-color); color: white;">
                        <i class="bi bi-arrow-left"></i> Torna al Catalogo
                    </a>
                </div>
            </div>

            <div class="col-lg-4 mt-4 mt-lg-0" id="cart-summary-column">
                <div class="order-summary-box p-3" >
                    <h4 class="summary-title mb-3">TOTALE:</h4>
                    <p id="total" class="total-amount display-6 fw-bold my-3"></p>
                    <a id="btn-procedi" href="checkout.html" class="btn checkout-btn w-100 rounded-pill text-decoration-none" role="button">
                        PROCEDI ALL'ORDINE
                    </a>
                </div>
            </div>
        </div>
    </main>

    <a href="#" id="scrollToTopBtn" class="scroll-to-top" title="Torna su">
        <i class="bi bi-arrow-up"></i>
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/fetcher.js"></script>
    <script src="js/headerShower.js"></script>
    <script src="js/getCartProducts.js"></script>
    <script>
        // This function should be called by getCartProducts.js after cart data is loaded
        // and also after any operation that modifies the cart and reloads/updates its state.
        function updateCartView(isCartEmpty) {
            const emptyCartMessageDiv = document.getElementById('empty-cart-message');
            const cartProductsDiv = document.getElementById('cart-products');
            const cartSummaryColumn = document.getElementById('cart-summary-column');
            const cartContentColumn = document.getElementById('cart-content-column');

            if (isCartEmpty) {
                if (emptyCartMessageDiv) emptyCartMessageDiv.style.display = 'block';
                if (cartProductsDiv) cartProductsDiv.style.display = 'none'; // Hide loading/original content
                if (cartSummaryColumn) cartSummaryColumn.style.display = 'none';
                if (cartContentColumn) {
                    cartContentColumn.classList.remove('col-lg-8');
                    cartContentColumn.classList.add('col-lg-12');
                }
            } else {
                if (emptyCartMessageDiv) emptyCartMessageDiv.style.display = 'none';
                if (cartProductsDiv) cartProductsDiv.style.display = 'block';
                if (cartSummaryColumn) cartSummaryColumn.style.display = 'block';
                if (cartContentColumn) {
                    cartContentColumn.classList.remove('col-lg-12');
                    cartContentColumn.classList.add('col-lg-8');
                }
            }
        }

        // The functions below (deleteCartProduct, dimCartProductQta, addCartProductQta)
        // mostly rely on window.location.reload(). After a reload, getCartProducts.js
        // should run and call updateCartView with the new cart state.
        async function deleteCartProduct(id){
            let result = await fetchData(`/api/cart/items/${id}`, "DELETE");

            if(result.status == 200){
                window.location.reload();
            }
        }

        async function dimCartProductQta(id){
            let result = await fetchData(`api/cart/items/${id}/subtract`, "PUT", {"quantita": 1});
            let counter = document.getElementById(`num-${id}`);
            counter.value = parseInt(counter.value) - 1;
            

            if(result.status == 200){
                document.getElementById(`price-${id}`).textContent = `€${result.data.totaleparziale}`;
                let idUser = (await fetchData("/api/auth/session-info", "GET")).data.idutente;
                let totCartUpdate = (await fetchData(`/api/cart/${idUser}`, "GET")).data.totaleCarrello;
                document.getElementById("total").textContent = `€${totCartUpdate}`;
                
                if(counter.value == 0){
                    window.location.reload();
                }
            }else if(result.status == 404){
                window.location.reload();
            }
        }

        async function addCartProductQta(id){
            let result = await fetchData(`api/cart/items/${id}/add`, "PUT", {"quantita": 1});
            let counter = document.getElementById(`num-${id}`);
            counter.value = parseInt(counter.value) + 1;

            if(result.status == 200){
                document.getElementById(`price-${id}`).textContent = `€${result.data.totaleparziale}`;
                let idUser = (await fetchData("/api/auth/session-info", "GET")).data.idutente;
                let totCartUpdate = (await fetchData(`/api/cart/${idUser}`, "GET")).data.totaleCarrello;
                document.getElementById("total").textContent = `€${totCartUpdate}`;
            }else if(result.status == 404){
                window.location.reload();
            }
        }
    </script>
</body>
</html>