<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Account</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/pages/dashboardUtente.css">
</head>

<body>
    <header class="py-3 mb-4 border-bottom d-none d-lg-block custom-header">
        <div class="container d-flex flex-wrap justify-content-between align-items-center">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <ul class="nav nav-pills align-items-center">
                <li class="nav-item dropdown invisible">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardUtente.html"><i
                                    class="bi bi-person-fill me-2"></i>IL MIO PROFILO</a></li>
                        <li><a class="dropdown-item" href="dashboardStoricoOrdini.html"><i
                                    class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI</a></li>
                        <li><a class="dropdown-item" href="leMieSegnalazioni.html"><i
                                    class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="logout.html"><i
                                    class="bi bi-box-arrow-right me-2"></i>LOGOUT</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown invisible-admin">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <!-- ADMIN -->
                    <ul class="invisible-admin dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardAdmin.html"><i
                                    class="bi bi-person-fill me-2"></i>ACCETTAZIONE</a></li>
                        <li><a class="dropdown-item" href="gestione.html"><i
                                    class="bi bi-box-seam-fill me-2"></i>GESTIONE SEGNALAZIONE</a></li>
                        <li><a class="dropdown-item" href="logout.html"><i class="bi bi-flag-fill me-2"></i>LOGOUT</a>
                        </li>
                    </ul>
                    <!-- FINE -->
                </li>
                <!-- UNLOGGED -->
                <li class="nav-item unlogged"><a href="login.html" class="nav-link"
                        style="color: var(--secondary-color);">ACCEDI</a></li>
                <li class="nav-item unlogged" style="color: var(--secondary-color)">|</li>
                <li class="nav-item unlogged"><a href="registrati.html" class="nav-link"
                        style="color: var(--secondary-color);">REGISTRATI</a></li>
                <!--FINE-->
                <li class="nav-item">
                    <!-- UNLOGGED -->
                    <a href="login.html" class="nav-link unlogged" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-4"></i>
                    </a>
                    <!--FINE-->
                    <a href="carrelloUtente.html" class="nav-link invisible" style="color: var(--secondary-color);">
                        <span class="position-relative d-inline-block">
                            <i id="cart-icon-lg" class="bi bi-cart fs-3"></i>
                            <span id="cart-item-count-lg" class="position-absolute top-0 start-100 mt-2 cart-item-badge-position badge rounded-pill bg-danger" style="display: none;">0</span>
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </header>

    <!-- Navbar per schermi < lg -->
    <nav class="py-3 navbar bg-body-tertiary fixed-top d-lg-none">
        <!-- Mantenuto fixed-top come richiesto in precedenza -->
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <button class="navbar-toggler me-auto" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>
            <div class="ms-auto"></div> <!-- Spacer to push toggler and logo to the left -->

            <!-- Offcanvas UNLOGGED -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header unlogged">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menù</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body unlogged">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="login.html">
                                    <i class="bi bi-person-fill me-2"></i>ACCEDI
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" aria-current="page" href="registrati.html"> <i
                                        class="bi bi-pencil-square me-2"></i>REGISTRATI
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Offcanvas menu LOGGED-->
                <div class="offcanvas-header invisible">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Il Mio Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body invisible">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="dashboardUtente.html">
                                    <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="dashboardStoricoOrdini.html"> <i
                                        class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="leMieSegnalazioni.html"> <i
                                        class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                                </a>
                            </li>
                        </ul>
                        <hr class="sidebar-divider">
                        <a href="logout.html">
                            <button onclick="window.location.href='logout.html'" class="btn logout-btn w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                            </button>
                        </a>
                    </div>
                </div>
            </div>
            <ul class="nav nav-pills align-items-center">
                <!-- Rimosso ms-auto qui, lo gestisce justify-content-between -->
                <li class="nav-item"> <!-- Aggiunto ms-auto all'ul per spingerlo a destra -->
                    <a href="carrelloUtente.html" class="nav-link nav-link-cart invisible" style="color: var(--secondary-color);">
                        <span class="position-relative d-inline-block">
                            <i id="cart-icon-sm" class="bi bi-cart fs-3"></i>
                            <span id="cart-item-count-sm" class="position-absolute top-0 start-100 mt-2 cart-item-badge-position badge rounded-pill bg-danger" style="display: none;">0</span>
                        </span>
                    </a>
                    <a href="login.html" class="nav-link nav-link-cart unlogged">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container my-4 pt-5 pt-lg-0">
        <h2 class="page-main-title mb-4">Il Mio Account</h2>
        <div class="row">
            <div class="col-md-3">
                <div class="dashboard-sidebar d-flex flex-column">
                    <ul class="nav nav-pills flex-column mb-auto">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="dashboardUtente.html">
                                <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="dashboardStoricoOrdini.html"> <i
                                    class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="leMieSegnalazioni.html"> <i class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                            </a>
                        </li>
                    </ul>
                    <hr class="sidebar-divider">
                    <button onclick="window.location.href='logout.html'" class="btn logout-btn w-100">
                        <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                    </button>
                </div>
            </div>

            <div class="col-md-9">
                <div class="dashboard-content p-4">
                    <h3 class="content-title mb-4">Modifica i tuoi dati</h3>
                    <form id="profileEditForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="firstName" class="form-label">Nome</label>
                                <input type="text" class="form-control dashboard-input" id="firstName" value="">
                            </div>
                            <div class="col-md-6">
                                <label for="lastName" class="form-label">Cognome</label>
                                <input type="text" class="form-control dashboard-input" id="lastName" value="">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control dashboard-input" id="username" value="">
                                <div class="invalid-feedback" id="username-error-msg">
                                    <!-- messaggio di errore apparirà qui-->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control dashboard-input" id="email">
                                <div class="invalid-feedback" id="email-error-msg">
                                    <!-- messaggio di errore apparirà qui-->
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Indirizzo</label>
                            <input type="text" class="form-control dashboard-input" id="address" value="">
                        </div>
                        <div class="text-center mt-4">
                            <!-- General messages container -->
                            <div id="form-messages" class="mb-3" style="min-height: 1.5em;">
                                <!-- Success message -->
                                <span class="success-text" id="success" style="display: none;">Modifica avvenuta con
                                    successo!</span>
                                <!-- General error message -->
                                <span class="error-text" id="error" style="display: none;">Si è verificato un errore.
                                    Riprova.</span>
                                <button type="button" onclick="saveData()"
                                    class="btn rounded-pill save-changes-btn">SALVA CAMBIAMENTI</button>
                            </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/fetcher.js"></script>
    <script src="js/headerShower.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            const nome = document.getElementById("firstName");
            const cognome = document.getElementById("lastName");
            const username = document.getElementById("username");
            const email = document.getElementById("email");
            const indirizzo = document.getElementById("address");

            //inizialmente i messaggi sono nascosti
            document.getElementById("success").style.display = "none";
            document.getElementById("error").style.display = "none";


            let infos = (await fetchData("/api/auth/session-info", "GET"));
            if (infos.status == 200) {
                nome.value = infos.data.nome;
                cognome.value = infos.data.cognome;
                username.value = infos.data.username;
                email.value = infos.data.email;
                indirizzo.value = infos.data.indirizzo;
            } else {
                //console.log("Errore caricamento prodotti!")
                document.getElementById("error").textContent = "Errore nel caricamento dei dati utente.";
                document.getElementById("error").style.display = "block";

            }
        })
    </script>
    <script>
        function clearFormErrors() {
            const inputs = [
                document.getElementById("firstName"),
                document.getElementById("lastName"),
                document.getElementById("username"),
                document.getElementById("email"),
                document.getElementById("address")
            ];
            inputs.forEach(input => {
                input.classList.remove("is-invalid", "is-valid");
            });

            document.getElementById("username-error-msg").textContent = "";
            document.getElementById("email-error-msg").textContent = "";
            document.getElementById("success").style.display = "none";
            document.getElementById("error").style.display = "none";
        }
        async function saveData() {
            clearFormErrors();

            let infos = (await fetchData("/api/auth/session-info", "GET"));
            if (!infos || infos.status !== 200 || !infos.data || !infos.data.idutente) {
                document.getElementById("error").textContent = "Impossibile recuperare informazioni utente per il salvataggio.";
                document.getElementById("error").style.display = "block";
                return;
            }

            const nomeInput = document.getElementById("firstName");
            const cognomeInput = document.getElementById("lastName");
            const usernameInput = document.getElementById("username");
            const emailInput = document.getElementById("email");
            const indirizzoInput = document.getElementById("address");


            const successMessage = document.getElementById("success");


            const generalErrorMessage = document.getElementById("error");



            let obj = {
                "username": usernameInput.value,
                "nome": nomeInput.value,
                "cognome": cognomeInput.value,
                "email": emailInput.value,
                "indirizzo": indirizzoInput.value

            }

            let result = await fetchData(`/api/users/${infos.data.idutente}`, "PUT", obj)

            if (result.status == 200) {
                successMessage.textContent = "Modifiche salvate con successo!";
                successMessage.style.display = "block";
                [nomeInput, cognomeInput, usernameInput, emailInput, indirizzoInput].forEach(input => input.classList.add("is-valid"));

            } else {
                let errorMessageText = "Si è verificato un errore durante l'aggiornamento.";
                if (result.body && result.body.errors) { // Example: { errors: { email: "Email già in uso", username: "..."}}
                    if (result.body.errors.email) {
                        emailInput.classList.add("is-invalid");
                        document.getElementById("email-error-msg").textContent = result.body.errors.email;
                    }
                    if (result.body.errors.username) {
                        usernameInput.classList.add("is-invalid");
                        document.getElementById("username-error-msg").textContent = result.body.errors.username;
                    }
                    // If there are specific field errors, you might not want to show the general one, or make it more generic.
                } else if (result.body && result.body.message) { // Example: { message: "Email già in uso", field: "email" }
                    errorMessageText = result.body.message; // More specific general error
                    if (result.body.field === "email") {
                        emailInput.classList.add("is-invalid");
                        document.getElementById("email-error-msg").textContent = result.body.message;
                    } else if (result.body.field === "username") {
                        usernameInput.classList.add("is-invalid");
                        document.getElementById("username-error-msg").textContent = result.body.message;
                    }
                }
                //generalErrorMessage.textContent = errorMessageText;
                //generalErrorMessage.style.display = "block";

            }
        }
    </script>
</body>

</html>