<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vetrina Artigiano</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/pages/dettaglioArtigiano.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>

<body>
    <header class="py-3 mb-4 border-bottom d-none d-lg-block fixed-top custom-header">
        <div class="container d-flex flex-wrap justify-content-between align-items-center">
            <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <ul class="nav nav-pills align-items-center">
                <li class="nav-item dropdown invisible">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="dashboardUtente.html"><i
                                    class="bi bi-person-fill me-2"></i>IL MIO PROFILO</a></li>
                        <li><a class="dropdown-item" href="dashboardStoricoOrdini.html"><i
                                    class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI</a></li>
                        <li><a class="dropdown-item" href="leMieSegnalazioni.html"><i
                                    class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="logout.html"><i
                                    class="bi bi-box-arrow-right me-2"></i>LOGOUT</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown invisible-admin">
                    <a class="nav-link dropdown-toggle" href="#" id="userAccountDropdown" role="button"
                        data-bs-toggle="dropdown" aria-expanded="false" style="color: var(--secondary-color);">
                        <i class="bi bi-person-circle fs-3 me-2"></i> <span id="nav-username">Username</span>
                    </a>
                    <!-- ADMIN -->
                    <ul class="invisible-admin dropdown-menu dropdown-menu-end" aria-labelledby="userAccountDropdown">
                        <li><a class="dropdown-item" href="accettazioniAdmin.html"><i
                                    class="bi bi-person-fill me-2"></i>ACCETTAZIONE</a></li>
                        <li><a class="dropdown-item" href="segnalazioniAdmin.html"><i
                                    class="bi bi-box-seam-fill me-2"></i>GESTIONE SEGNALAZIONE</a></li>
                        <li><a class="dropdown-item" href="logout.html"><i class="bi bi-flag-fill me-2"></i>LOGOUT</a>
                        </li>
                    </ul>
                    <!-- FINE -->
                </li>
                <!-- UNLOGGED -->
                <li class="nav-item unlogged"><a href="login.html" class="nav-link"
                        style="color: var(--secondary-color);">ACCEDI</a></li>
                <li class="nav-item unlogged" style="color: var(--secondary-color)">|</li>
                <li class="nav-item unlogged"><a href="registrati.html" class="nav-link"
                        style="color: var(--secondary-color);">REGISTRATI</a></li>
                <!--FINE-->
                <li class="nav-item">
                    <!-- UNLOGGED -->
                    <a href="login.html" class="nav-link unlogged" style="color: var(--secondary-color);">
                        <i class="bi bi-cart fs-4"></i>
                    </a>
                    <!--FINE-->
                    <a href="carrelloUtente.html" class="nav-link invisible" style="color: var(--secondary-color);">
                        <span class="position-relative d-inline-block">
                            <i id="cart-icon-lg" class="bi bi-cart fs-3"></i>
                            <span id="cart-item-count-lg" class="position-absolute top-0 start-100 mt-2 cart-item-badge-position badge rounded-pill bg-danger" style="display: none;">0</span>
                        </span>
                    </a>
                </li>
            </ul>
        </div>
    </header>

    <!-- Navbar per schermi < lg -->
    <nav class="py-3 navbar bg-body-tertiary fixed-top d-lg-none">
        <!-- Mantenuto fixed-top come richiesto in precedenza -->
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <button class="navbar-toggler me-auto" type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a href="/" class="d-flex align-items-center text-dark text-decoration-none">
                <img src="assets/Logo.svg" alt="Logo" class="me-2" style="height: 80px;">
            </a>

            <div class="ms-auto"></div> <!-- Spacer to push toggler and logo to the left -->

            <!-- Offcanvas UNLOGGED -->
            <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasNavbar"
                aria-labelledby="offcanvasNavbarLabel">
                <div class="offcanvas-header unlogged">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Menù</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body unlogged">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="login.html">
                                    <i class="bi bi-person-fill me-2"></i>ACCEDI
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="registrati.html"> <i
                                        class="bi bi-pencil-square me-2"></i>REGISTRATI
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Offcanvas menu LOGGED-->
                <div class="offcanvas-header invisible">
                    <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Il Mio Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                <div class="offcanvas-body invisible">
                    <div class="dashboard-sidebar-offcanvas d-flex flex-column h-100">
                        <ul class="nav nav-pills flex-column mb-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="dashboardUtente.html">
                                    <i class="bi bi-person-fill me-2"></i>IL MIO PROFILO
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" aria-current="page" href="dashboardStoricoOrdini.html"> <i
                                        class="bi bi-box-seam-fill me-2"></i>I MIEI ORDINI
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="leMieSegnalazioni.html"> <i
                                        class="bi bi-flag-fill me-2"></i>LE MIE SEGNALAZIONI
                                </a>
                            </li>
                        </ul>
                        <hr class="sidebar-divider">
                        <a href="logout.html">
                            <button class="btn logout-btn w-100">
                                <i class="bi bi-box-arrow-right me-2"></i>LOGOUT
                            </button>
                        </a>
                    </div>
                </div>
            </div>
            <ul class="nav nav-pills align-items-center">
                <!-- Rimosso ms-auto qui, lo gestisce justify-content-between -->
                <li class="nav-item"> <!-- Aggiunto ms-auto all'ul per spingerlo a destra -->
                    <a href="carrelloUtente.html" class="nav-link nav-link-cart invisible" style="color: var(--secondary-color);">
                        <span class="position-relative d-inline-block">
                            <i id="cart-icon-sm" class="bi bi-cart fs-3"></i>
                            <span id="cart-item-count-sm" class="position-absolute top-0 start-100 mt-2 cart-item-badge-position badge rounded-pill bg-danger" style="display: none;">0</span>
                        </span>
                    </a>
                    <a href="login.html" class="nav-link nav-link-cart unlogged">
                        <i class="bi bi-cart fs-3"></i>
                    </a>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container my-4 pt-lg-0">
        <div class="row mb-3">
            <div class="col">
                <a href="#" class="back-to-search-link" id="backLink">
                    <i class="bi bi-arrow-left-circle me-1"></i>
                    Indietro
                </a>
            </div>
        </div>

        <div id="artisan-loading-placeholder" class="text-center p-5 my-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <h2 class="mt-3" style="color: var(--primary-color);">Caricamento Vetrina Artigiano...</h2>
            <p class="text-muted">Stiamo recuperando i dettagli per te.</p>
        </div>

        <div id="artisan-page-content" style="display: none;">
            <div class="row">
                <div class="col-lg-4 col-md-5 mb-4 mb-md-0">
                    <div class="artisan-info-box">
                        <h3 id="nomeArtigiano" class="artisan-name"></h3>
                        <p id="indirizzoArtigiano" class="artisan-address"></p>
                        <hr>
                        <h5 class="description-label">Descrizione</h5>
                        <div id="descArtigiano" class="artisan-description-content">
                            <!-- Description loaded by JS -->
                        </div>
                    </div>
                </div>
    
                <div class="col-lg-8 col-md-7">
                    <h2 class="products-available-title mb-3">Prodotti Disponibili</h2>
                    <div id="artisan-products" class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 g-4">
                        <!-- Products will be loaded here by JavaScript -->
                        <!-- The initial "Caricamento prodotti..." message is removed as the parent is hidden -->
                    </div>
                </div>
            </div>
        </div>
    </main>
                    <!-- Message Placeholder -->
    <div id="actionMessage" class="alert" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; display: none; transition: opacity 0.5s ease-out; min-width: 300px; text-align: center;" role="alert">
        <!-- Message will be injected here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/ratingUtils.js"></script>
    <script src="js/headerShower.js"></script>
    <script src="js/fetcher.js"></script>
    <script src="js/addCartProduct.js"></script>
    <script>
        async function showProducts(productsResult, sessionInfo) { // Added sessionInfo parameter
            const productsContainer = document.getElementById("artisan-products");
            if (!productsContainer) {
                console.error("Product container #artisan-products not found.");
                return;
            }
            productsContainer.innerHTML = ''; // Clear previous content

            if (!productsResult || !productsResult.data || productsResult.data.length === 0) {
                productsContainer.innerHTML = '<p class="col-12 text-muted">Nessun prodotto disponibile per questo artigiano.</p>';
                return;
            }

            const productCardPromises = productsResult.data.map(async (product) => {
                let ratingHtml = '<small class="text-muted">Caricamento rating...</small>';
                if (typeof getHTMLforAverageRating === 'function') {
                    try {
                        ratingHtml = await getHTMLforAverageRating(product.idprodotto);
                    } catch (e) {
                        console.error(`Error fetching rating for product ${product.idprodotto}:`, e);
                        ratingHtml = '<small class="text-muted">Rating non disp.</small>';
                    }
                } else {
                    console.warn('getHTMLforAverageRating function not found. Make sure ratingUtils.js is loaded before this script.');
                    ratingHtml = '<small class="text-muted">Errore rating (func)</small>';
                }

                let buttonHtml = '';
                const isLoggedIn = sessionInfo && sessionInfo.status === 200 && sessionInfo.data && sessionInfo.data.idutente;
                const isUserNotAdmin = isLoggedIn && sessionInfo.data.tipologia !== "Admin";

                if (isUserNotAdmin) {
                    buttonHtml = `
                        <button onclick="aggiungiAlCarrello(${product.idprodotto}, 1, this)" class="btn btn-sm mt-3 add-to-cart-button-artisan add-to-cart-button">
                            <span class="button-text"><i class="bi bi-cart-plus"></i> Aggiungi al Carrello</span>
                        </button>`;
                } else { // Unlogged or Admin (admins don't shop from artisan details page this way)
                    buttonHtml = `
                        <a href="login.html" class="btn btn-sm mt-3 add-to-cart-button-artisan">
                            <i class="bi bi-cart"></i> Accedi per acquistare
                        </a>`;
                }

                return `
                    <div class="col">
                        <div class="card h-100 product-card-artisan">
                            <a href="dettaglioProdotto.html?id=${product.idprodotto}" class="text-decoration-none text-dark">
                                <div class="product-image-placeholder d-flex align-items-center justify-content-center">
                                    <img src="/api/products/${product.idprodotto}/image_content" class="imageProduct" alt="${product.nome}" style="max-height: 180px; width: 100%; object-fit: cover;">
                                </div>
                            </a>
                            <div class="card-body d-flex flex-column">
                                <ul class="list-unstyled mt-2 mb-auto product-info-list">
                                    <li class="product-name-list-item">${product.nome}</li>
                                    <li class="product-rating-list-item">
                                        ${ratingHtml}
                                    </li>
                                    <li class="product-price-list-item">Prezzo: €${parseFloat(product.prezzounitario).toFixed(2)}</li>
                                </ul>
                                ${buttonHtml}
                            </div>
                        </div>
                    </div>`;
            });

            const productCardsHtml = await Promise.all(productCardPromises);
            productsContainer.innerHTML = productCardsHtml.join('');
        }

        document.addEventListener("DOMContentLoaded", async function () {
            const loadingPlaceholder = document.getElementById('artisan-loading-placeholder');
            const artisanPageContent = document.getElementById('artisan-page-content');
            const backButton = document.getElementById("backLink");

            // Logic for the back button (moved from the first DOMContentLoaded listener)
            const prodottoprec = sessionStorage.getItem("id");
            if (prodottoprec) {
                backButton.href = `dettaglioProdotto.html?id=${prodottoprec}`;
            } else {
                backButton.href = "index.html"; // Fallback if no previous product ID
            }


            if (!loadingPlaceholder || !artisanPageContent) {
                console.error("Elementi base per il caricamento (placeholder o content) non trovati.");
                document.body.innerHTML = "<p class='text-center text-danger p-5'>Errore critico: la pagina non può essere caricata correttamente.</p>";
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const artisanId = urlParams.get('id');

            if (!artisanId) {
                loadingPlaceholder.innerHTML = `
                    <div class="text-center p-5 my-5">
                        <i class="bi bi-exclamation-triangle-fill fs-1 text-danger"></i>
                        <h2 class="mt-3 text-danger">ID Artigiano Mancante</h2>
                        <p class="text-muted">Impossibile caricare i dettagli dell'artigiano senza un ID.</p>
                        <a href="index.html" class="btn btn-primary">Torna alla Home</a>
                    </div>`;
                return;
            }

            let sessionInfo = null; // To store session info

            try {
                sessionInfo = await fetchData("/api/auth/session-info", "GET"); // Fetch session info once
                // Fetch artisan details using artisanId
                const artisanResult = await fetchData(`/api/users/${artisanId}`, "GET");
                if (artisanResult.status === 200 && artisanResult.data) {
                    document.getElementById("nomeArtigiano").textContent = artisanResult.data.username;
                    document.getElementById("indirizzoArtigiano").textContent = artisanResult.data.indirizzo || "Indirizzo non specificato";
                    document.getElementById("descArtigiano").innerHTML = (artisanResult.data.artigianodescrizione || "Nessuna descrizione fornita.").replace(/\n/g, '<br>');
                } else {
                    throw new Error(artisanResult.message || "Errore nel caricamento dei dati dell'artigiano.");
                }

                // Fetch artisan products
                const productsReq = await fetchData(`/api/products/notdeleted?idartigiano=${artisanId}`, "GET");
                if (productsReq.status === 200) {
                    await showProducts(productsReq, sessionInfo); // Pass sessionInfo
                } else {
                     // If products fail to load, showProducts will handle the message or we can set a general one
                    document.getElementById("artisan-products").innerHTML = `<p class="col-12 text-warning">Errore nel caricamento dei prodotti dell'artigiano.</p>`;
                }

                // Show content and hide placeholder
                loadingPlaceholder.style.display = 'none';
                artisanPageContent.style.display = 'block';

            } catch (error) {
                console.error("Errore nel caricamento della pagina artigiano:", error);
                loadingPlaceholder.innerHTML = `
                    <div class="text-center p-5 my-5">
                        <i class="bi bi-emoji-frown fs-1 text-danger"></i>
                        <h2 class="mt-3 text-danger">Oops! Qualcosa è andato storto.</h2>
                        <p class="text-muted">Impossibile caricare la vetrina dell'artigiano: ${error.message}. Riprova più tardi.</p>
                        <a href="index.html" class="btn btn-primary">Torna alla Home</a>
                    </div>`;
                artisanPageContent.style.display = 'none'; // Ensure content remains hidden
            }
        });
    </script>
</body>
</html>